#include <linux/input-event-codes.h>
#include <stdio.h>
#include <stdlib.h>
#include <time.h>

#include "owm.h"
#include "events.h"
#include "window.h"
#include "render.h"
#include "backend/backend.h"

bool running = true;
uint32_t mouse_pos_x = 0;
uint32_t mouse_pos_y = 0;

void keyboard_key_press_callback(uint16_t key_code, OWM_KeyEventType event_type) {
  if (event_type == OWM_EVENT_KEY_EVENT_PRESS && key_code == KEY_ESC) {
    running = false;
  }
  OWM_processWindowKeyEvent(key_code, event_type);
}

void mouse_key_press_callback(uint16_t key_code, OWM_KeyEventType event_type) {
  OWM_processWindowMouseButtonEvent(mouse_pos_x, mouse_pos_y, key_code, event_type);
}

void mouse_move_callback(int rel_x, int rel_y) {
  if (rel_x < 0 && (uint32_t) abs(rel_x) > mouse_pos_x) {
    mouse_pos_x = 0;
    rel_x = 0;
  } else if (mouse_pos_x + rel_x > OWM_drmGetBufferWidth() - 1) {
    rel_x = OWM_drmGetBufferWidth() - 1 - mouse_pos_x;
    mouse_pos_x = OWM_drmGetBufferWidth() - 1;
  } else {
    mouse_pos_x += rel_x;
  }

  if (rel_y < 0 && (uint32_t) abs(rel_y) > mouse_pos_y) {
    mouse_pos_y = 0;
    rel_y = 0;
  } else if (mouse_pos_y + rel_y > OWM_drmGetBufferHeight() - 1) {
    rel_y = OWM_drmGetBufferHeight() - 1 - mouse_pos_y;
    mouse_pos_y = OWM_drmGetBufferHeight() - 1;
  } else {
    mouse_pos_y += rel_y;
  }

  OWM_processWindowMouseEvent(mouse_pos_x, mouse_pos_y, rel_x, rel_y);
}

int main() {
  srand(time(NULL)); // Just to get different colors on dummy windows on each run

  if (OWM_init()) {
    fprintf(stderr, "Failed to initialize owm\n");
    return 1;
  }

  OWM_setKeyboardKeyPressCallback(keyboard_key_press_callback);
  OWM_setMouseKeyPressCallback(mouse_key_press_callback);
  OWM_setMouseMoveCallback(mouse_move_callback);

  while (running) {
    OWM_pollEvents();

    if (OWM_drmIsNextBufferFree()) {
      // Render
      OWM_FrameBuffer *frameBuffer = OWM_drmAquireFreeFrameBuffer();
      uint32_t clear_color = 0x00000000;
      uint32_t *pixel = frameBuffer->pixels;
      // Clear screen
      for (uint32_t y = 0; y < OWM_drmGetBufferHeight(); ++y) {
        for (uint32_t x = 0; x < OWM_drmGetBufferWidth(); ++x) {
          pixel[x] = clear_color;
        }
        // pixel += frameBuffer->buffer.pitch / 4; // Divide by 4, since pixel jumps by 4 bytes
        pixel += frameBuffer->stride;
      }

      // Draw windows
      OWM_renderWindows(frameBuffer);

      // Draw cursor
      uint32_t cursor_color = 0x00FFFFFF;
      pixel = frameBuffer->pixels;
      // pixel[mouse_pos_y * frameBuffer->buffer.pitch / 4 + mouse_pos_x] = cursor_color;
      pixel[mouse_pos_y * frameBuffer->stride + mouse_pos_x] = cursor_color;

      if (OWM_drmFlipRenderContext() != 0) {
        fprintf(stderr, "Failed to submit swap frame buffer request\n");
      }
    }
  }

  OWM_shutdown();

  return 0;
}
